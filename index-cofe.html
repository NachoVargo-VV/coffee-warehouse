<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Склад + кофейные автоматы</title>
<style>
  :root { --bg:#0f1222;--card:#171a2e;--muted:#8f9bb3;--text:#e8ebf7;--accent:#6ea8fe;--ok:#28c76f;--warn:#ff9f43;--bad:#ea5455;--border:#242845;--chip:#212542; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:-apple-system,Inter,system-ui,Segoe UI,Roboto,Arial;background:radial-gradient(1200px 800px at 80% -10%,#1f2452,#0f1222 40%),var(--bg);color:var(--text)}
  .app{max-width:1200px;margin:0 auto;padding:20px 16px 64px}
  header{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:16px}
  .brand{font-weight:700;font-size:18px;padding:10px 14px;border-radius:10px;background:linear-gradient(135deg,#2b2f59,#20244a);border:1px solid var(--border)}
  nav{display:flex;gap:6px;flex-wrap:wrap;background:rgba(17,20,40,.6);border:1px solid var(--border);border-radius:12px;padding:6px}
  .tab{border:1px solid transparent;background:transparent;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;transition:.15s;font-weight:600}
  .tab:hover{background:rgba(255,255,255,.04)} .tab.active{background:var(--chip);border-color:var(--border)}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-weight:600;font-size:12px;background:var(--chip);border:1px solid var(--border)}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,0));border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25),inset 0 1px 0 rgba(255,255,255,.04)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0 10px}
  .btn{border:1px solid var(--border);color:var(--text);background:linear-gradient(180deg,#29305b,#1e2348);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;transition:.15s}
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.25)} .btn.ghost{background:rgba(255,255,255,.02)}
  .btn.ok{background:linear-gradient(180deg,#2bc877,#1ea35e);border-color:rgba(40,199,111,.5)}
  .btn.warn{background:linear-gradient(180deg,#ffb463,#f39b3a)}
  .btn.bad{background:linear-gradient(180deg,#ff7b7b,#ea5455);border-color:rgba(234,84,85,.6)}
  select,input[type="text"],input[type="password"],input[type="number"],input[type="date"],input[type="email"]{background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px;outline:none}
  select:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(110,168,254,.15)}
  table{width:100%;border-collapse:collapse;border-spacing:0;font-size:14px;background:rgba(10,12,28,.4);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  thead th{text-align:left;padding:10px 12px;color:var(--muted);font-weight:600;background:rgba(255,255,255,.03);border-bottom:1px solid var(--border)}
  tbody td{padding:10px 12px;border-bottom:1px solid var(--border)}
  tbody tr:hover{background:rgba(255,255,255,.03)}
  .muted{color:var(--muted)} .status{font-weight:700}.status.ok{color:var(--ok)}.status.warn{color:var(--warn)}.status.bad{color:var(--bad)}
  .hidden{display:none!important} .login-box{max-width:520px;margin:10vh auto;padding:18px} .small{font-size:12px}
  .table-scroll{overflow-x:auto}
  @media (max-width: 640px){
    body{font-size:14px}
    table{font-size:12px}
    td,th{white-space:normal;word-break:break-word}
    .toolbar{flex-direction:column;align-items:flex-start}
    .section-title h3{font-size:16px;margin:0 0 6px}
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">Склад + кофейные автоматы</div>
    <nav id="nav" class="hidden"></nav>
    <div class="pill hidden" id="roleBadge">Роль: <span id="roleLabel"></span></div>
    <div class="pill hidden" id="pointBadge">Точка: <span id="pointLabel"></span></div>
    <button id="logoutBtn" class="btn ghost hidden">Выйти</button>
  </header>

  <div id="view-login" class="card login-box">
    <h3>Вход</h3>
    <div class="toolbar">
      <input id="emailInput" type="email" placeholder="Email"/>
      <input id="passInput" type="password" placeholder="Пароль"/>
      <button id="loginBtn" class="btn ok">Войти</button>
    </div>
    <div class="muted small">Админ и точки входят по email/паролю (создаются в консоли Firebase).</div>
  </div>

  <div id="view-admin-points" class="card hidden">
    <div class="section-title"><h3>Кофе-автоматы (точки)</h3><div class="muted">добавление, адреса</div></div>
    <div class="toolbar">
      <input id="pName" type="text" placeholder="Название точки"/>
      <input id="pAddr" type="text" placeholder="Адрес"/>
      <input id="pEmail" type="email" placeholder="Email точки (должен существовать в Auth)"/>
      <button id="addPointBtn" class="btn ok">Добавить</button>
    </div>
    <div id="pointsTable"></div>
  </div>

  <div id="view-admin-stocks" class="card hidden">
    <div class="section-title"><h3>Остатки склада</h3><div class="muted">создание, пополнение, списание и удаление</div></div>
    <div class="toolbar">
      <input id="newSku" type="text" placeholder="SKU (уникальный)"/>
      <input id="newName" type="text" placeholder="Наименование"/>
      <input id="newQty" type="number" min="0" step="1" placeholder="Нач. остаток" style="width:140px"/>
      <button id="addProductBtn" class="btn ok">Создать товар</button>
    </div>
    <div id="adminStocksTable"></div>
  </div>

  <div id="view-admin-requests" class="card hidden">
    <div class="section-title"><h3>Заявки на перемещение</h3><div class="muted">подтверждение, списание, удаление</div></div>
    <div class="toolbar">
      <label>Точка: <select id="reqPointFilter"><option value="">Все</option></select></label>
    </div>
    <div id="adminRequestsTable"></div>
  </div>

  <div id="view-admin-water" class="card hidden">
    <div class="section-title"><h3>Заказы воды</h3><div class="muted">по точкам</div></div>
    <div class="toolbar">
      <label>Точка: <select id="waterPointFilter"><option value="">Все</option></select></label>
      <label>с <input id="waterFrom" type="date"/></label>
      <label>по <input id="waterTo" type="date"/></label>
    </div>
    <div id="adminWaterTable"></div>
    <div id="adminWaterMonth"></div>
  </div>

  <div id="view-admin-cash" class="card hidden">
    <div class="section-title"><h3>Инкассации</h3><div class="muted">по точкам</div></div>
    <div class="toolbar">
      <label>Точка: <select id="cashPointFilter"><option value="">Все</option></select></label>
      <label>с <input id="cashFrom" type="date"/></label>
      <label>по <input id="cashTo" type="date"/></label>
    </div>
    <div id="adminCashTable"></div>
    <div id="adminCashTotals"></div>
  </div>

  <div id="view-admin-stats" class="card hidden">
    <div class="section-title"><h3>Статистика</h3><div class="muted">перемещения и вода</div></div>
    <div class="toolbar">
      <label>Точка: <select id="statsPointFilter"><option value="">Все</option></select></label>
      <label>Период:
        <select id="statsPeriod">
          <option value="today">Сегодня</option>
          <option value="yesterday">Вчера</option>
          <option value="week">Неделя</option>
          <option value="month">Месяц</option>
          <option value="custom">Выбрать...</option>
        </select>
      </label>
      <label>с <input id="statsFrom" type="date" disabled/></label>
      <label>по <input id="statsTo" type="date" disabled/></label>
    </div>
    <div id="statsTransfers"></div>
    <div style="height:10px"></div>
    <div id="statsWater"></div>
    <div id="statsTransfersChart" style="margin-top:10px"></div>
    <div id="statsWaterChart" style="margin-top:10px"></div>
  </div>

  <div id="view-point-stocks" class="card hidden">
    <div class="section-title"><h3>Остатки склада</h3><div class="muted">укажите количества к заявке</div></div>
    <div class="toolbar">
      <label>Дата заявки: <input id="reqDate" type="date"/></label>
      <button id="sendReqBtn" class="btn ok">Отправить заявку</button>
    </div>
    <div id="pointStocksTable"></div>
  </div>

  <div id="view-point-myreq" class="card hidden">
    <div class="section-title"><h3>Мои заявки</h3><div class="muted">список ваших заявок</div></div>
    <div id="pointMyReqTable"></div>
  </div>

  <div id="view-point-water" class="card hidden">
    <div class="section-title"><h3>Заказ воды</h3><div class="muted">по точке</div></div>
    <div class="toolbar">
      <label>Дата: <input id="waterDate" type="date"/></label>
      <label>Бутыли 19л: <input id="waterQty" type="number" min="1" value="1" style="width:100px"/></label>
      <button id="sendWaterBtn" class="btn ok">Отправить</button>
    </div>
    <div id="pointWaterList"></div>
  </div>

  <div id="view-point-cash" class="card hidden">
    <div class="section-title"><h3>Инкассация</h3><div class="muted">точка вводит сумму</div></div>
    <div class="toolbar">
      <label>Дата: <input id="cashDate" type="date"/></label>
      <label>Сумма ₽: <input id="cashAmt" type="number" min="0" step="0.01" style="width:140px"/></label>
      <button id="sendCashBtn" class="btn ok">Записать</button>
    </div>
    <div id="pointCashList"></div>
  </div>
</div>

<script type="module">
  const ADMIN_EMAIL = "vtumanevlad@mail.ru";
  const firebaseConfig = {
    apiKey: "AIzaSyDCy0hflpGk9yrgWwErEkZлM1F5UYYa-KU",
    authDomain: "coffee-warehouse-vv.firebaseapp.com",
    projectId: "coffee-warehouse-vv",
    storageBucket: "coffee-warehouse-vv.firebasestorage.app",
    messagingSenderId: "388563359895",
    appId: "1:388563359895:web:0eeead31f2bc4f229531d2",
    measurementId: "G-F9S09RBB4P"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc,
    onSnapshot, query, where, orderBy, runTransaction
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const qs = id => document.getElementById(id);
  const fmt = n => Number(n).toLocaleString("ru-RU");
  const today = () => new Date().toISOString().slice(0,10);
  const natCmp = (a,b) => String(a).localeCompare(String(b), undefined, { numeric:true, sensitivity:'base' });

  const state = { user:null, isAdmin:false, myPoint:null, unsub:[], points:[] };
  function clearSubs(){ state.unsub.forEach(u=>u&&u()); state.unsub=[]; }

  function renderNav(tabs){
    const nav=qs("nav");
    nav.innerHTML=tabs.map(t=>`<button class="tab ${t.active?'active':''}" data-id="${t.id}">${t.title}</button>`).join("");
    nav.classList.remove("hidden");
    nav.querySelectorAll("button").forEach(b=>{
      b.onclick=()=>{ tabs.forEach(t=>t.active=(t.id===b.dataset.id)); renderNav(tabs); showView(tabs.find(t=>t.active).id); };
    });
  }
  function showView(id){
    clearSubs();
    document.querySelectorAll("[id^='view-']").forEach(el=>el.classList.add("hidden"));
    qs(id)?.classList.remove("hidden");
    if(id==="view-admin-points") renderAdminPoints();
    if(id==="view-admin-stocks") renderAdminStocks();
    if(id==="view-admin-requests") renderAdminRequests();
    if(id==="view-admin-water") renderAdminWater();
    if(id==="view-admin-cash") renderAdminCash();
    if(id==="view-admin-stats") renderAdminStats();
    if(id==="view-point-stocks") renderPointStocks();
    if(id==="view-point-myreq") renderPointMyReq();
    if(id==="view-point-water") renderPointWater();
    if(id==="view-point-cash") renderPointCash();
  }

  onSnapshot(collection(db,"points"), snap=>{
    state.points = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  });

  qs("loginBtn").onclick = async () => {
    const email=(qs("emailInput").value||"").trim();
    const pass=(qs("passInput").value||"").trim();
    if(!email||!pass) return alert("Введите email и пароль");
    try { await signInWithEmailAndPassword(auth,email,pass); } catch(e){ alert("Ошибка входа: "+e.message); }
  };
  qs("logoutBtn").onclick = async () => { await signOut(auth); };

  onAuthStateChanged(auth, async (user)=>{
    clearSubs();
    document.querySelectorAll("[id^='view-']").forEach(el=>el.classList.add("hidden"));
    if(!user){
      state.user=null; state.isAdmin=false; state.myPoint=null;
      ["nav","logoutBtn","roleBadge","pointBadge"].forEach(id=>qs(id).classList.add("hidden"));
      qs("view-login").classList.remove("hidden");
      return;
    }
    state.user=user;
    state.isAdmin = (user.email||"").toLowerCase() === ADMIN_EMAIL.toLowerCase();
    qs("logoutBtn").classList.remove("hidden");
    qs("roleBadge").classList.remove("hidden");
    qs("roleLabel").textContent = state.isAdmin ? "Склад (админ)" : "Кофе-автомат";

    if (state.isAdmin) {
      const tabs=[
        {id:"view-admin-points",title:"Кофе-автоматы",active:true},
        {id:"view-admin-stocks",title:"Остатки"},
        {id:"view-admin-requests",title:"Заявки"},
        {id:"view-admin-water",title:"Вода"},
        {id:"view-admin-cash",title:"Инкассации"},
        {id:"view-admin-stats",title:"Статистика"},
      ];
      renderNav(tabs);
      showView("view-admin-points");
    } else {
      const tabs=[
        {id:"view-point-stocks",title:"Остатки",active:true},
        {id:"view-point-myreq",title:"Мои заявки"},
        {id:"view-point-water",title:"Вода"},
        {id:"view-point-cash",title:"Инкассация"},
      ];
      renderNav(tabs);
      showView("view-point-stocks");
      ensureMyPoint(user);
    }
  });

  async function ensureMyPoint(user){
    try {
      if (state.myPoint) return state.myPoint;
      const q1=query(collection(db,"points"), where("email","==",(user.email||"").toLowerCase()));
      const snap=await getDocs(q1);
      let point=null;
      if(snap.empty){
        const ref=await addDoc(collection(db,"points"), { email:(user.email||"").toLowerCase(), uid:user.uid, name:"", address:"" });
        point={ id:ref.id, email:user.email, uid:user.uid, name:"", address:"" };
      } else {
        const d=snap.docs[0];
        point={ id:d.id, ...d.data() };
        if(!point.uid) await updateDoc(doc(db,"points",point.id),{ uid:user.uid });
      }
      state.myPoint=point;
      qs("pointBadge").classList.remove("hidden");
      qs("pointLabel").textContent = point.name || point.email || "(точка)";
      return point;
    } catch(e) { console.warn(e); }
  }

  // Админ: точки
  async function renderAdminPoints(){
    qs("addPointBtn").onclick = async ()=>{
      const name=qs("pName").value.trim(), addr=qs("pAddr").value.trim(), email=(qs("pEmail").value||"").trim().toLowerCase();
      if(!name||!addr||!email) return alert("Заполните все поля");
      await addDoc(collection(db,"points"), { name, address:addr, email, uid:null, createdAt:Date.now() });
      ["pName","pAddr","pEmail"].forEach(id=>qs(id).value="");
    };
    state.unsub.push(onSnapshot(collection(db,"points"), snap=>{
      const rows = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      const body = rows.map(p=>`
        <tr data-rowp="${p.id}">
          <td class="muted" title="${p.id}">${p.name||p.email||p.id}</td>
          <td><input data-id="${p.id}" data-k="name" value="${p.name||""}" disabled/></td>
          <td><input data-id="${p.id}" data-k="address" value="${p.address||""}" disabled/></td>
          <td>${p.email||""}</td>
          <td class="muted">${p.uid||""}</td>
          <td style="text-align:right;">
            <button class="btn ghost" data-editp="${p.id}">Редактировать</button>
            <button class="btn ok hidden" data-savep="${p.id}">Сохранить</button>
            <button class="btn bad" data-delp="${p.id}">Удалить</button>
          </td>
        </tr>`).join("");
      qs("pointsTable").innerHTML=`<div class="table-scroll"><table><thead><tr><th>Точка</th><th>Название</th><th>Адрес</th><th>Email</th><th>UID</th><th></th></tr></thead><tbody>${body||`<tr><td colspan="6" class="muted">Нет точек</td></tr>`}</tbody></table></div>`;

      qs("pointsTable").querySelectorAll("[data-editp]").forEach(b=>{
        b.onclick=()=>{
          const id=b.dataset.editp;
          const row = qs("pointsTable").querySelector(`[data-rowp="${id}"]`);
          row.querySelectorAll(`input[data-id="${id}"]`).forEach(inp=>inp.disabled=false);
          row.querySelector(`[data-editp="${id}"]`).classList.add("hidden");
          row.querySelector(`[data-savep="${id}"]`).classList.remove("hidden");
        };
      });
      qs("pointsTable").querySelectorAll("[data-savep]").forEach(b=>{
        b.onclick=async ()=>{
          const id=b.dataset.savep;
          const row = qs("pointsTable").querySelector(`[data-rowp="${id}"]`);
          const inputs=[...row.querySelectorAll(`input[data-id="${id}"]`)];
          const upd={}; inputs.forEach(i=>upd[i.dataset.k]=i.value.trim());
          await updateDoc(doc(db,"points",id),upd);
          inputs.forEach(i=>i.disabled=true);
          row.querySelector(`[data-savep="${id}"]`).classList.add("hidden");
          row.querySelector(`[data-editp="${id}"]`).classList.remove("hidden");
        };
      });
      qs("pointsTable").querySelectorAll("[data-delp]").forEach(b=>{
        b.onclick=async ()=>{
          const id=b.dataset.delp;
          if(!confirm("Удалить точку?")) return;
          await deleteDoc(doc(db,"points",id));
        };
      });
    }));
  }

  // Админ: остатки (сортировка SKU натур.)
  async function renderAdminStocks(){
    qs("addProductBtn").onclick = async ()=>{
      let sku=(qs("newSku").value||"").trim().toUpperCase();
      const name=(qs("newName").value||"").trim();
      const qty=Math.max(0, Math.floor(Number(qs("newQty").value||0)));
      if(!sku||!name) return alert("Заполните SKU и наименование");
      const ref=doc(db,"inventory",sku);
      const exists=await getDoc(ref);
      if(exists.exists()) return alert("SKU уже существует");
      await setDoc(ref,{ name, qty });
      ["newSku","newName","newQty"].forEach(id=>qs(id).value="");
    };
    state.unsub.push(onSnapshot(collection(db,"inventory"), snap=>{
      const rows = snap.docs.map(d=>({ sku:d.id, ...d.data() })).sort((a,b)=>natCmp(a.sku,b.sku));
      const body = rows.map(p=>`
        <tr data-rowi="${p.sku}">
          <td>${p.sku}</td>
          <td><input data-sku="${p.sku}" data-k="name" value="${p.name||""}" disabled/></td>
          <td>${fmt(p.qty||0)}</td>
          <td><input type="number" min="0" step="1" style="width:100px" placeholder="+ Приход" data-add="${p.sku}"/></td>
          <td><input type="number" min="0" step="1" style="width:100px" placeholder="- Списание" data-sub="${p.sku}"/></td>
          <td style="text-align:right;">
            <button class="btn ghost" data-editn="${p.sku}">Редактировать</button>
            <button class="btn ok hidden" data-saven="${p.sku}">Сохранить</button>
            <button class="btn ok" data-inc="${p.sku}">Приход</button>
            <button class="btn warn" data-dec="${p.sku}">Списать</button>
            <button class="btn bad" data-del="${p.sku}">Удалить</button>
          </td>
        </tr>`).join("");
      qs("adminStocksTable").innerHTML=`<div class="table-scroll"><table><thead><tr><th>SKU</th><th>Наименование</th><th>Остаток</th><th>Пополнить</th><th>Списать</th><th></th></tr></thead><tbody>${body||`<tr><td colspan="6" class="muted">Нет товаров</td></tr>`}</tbody></table></div>`;

      qs("adminStocksTable").querySelectorAll("[data-editn]").forEach(b=>{
        b.onclick=()=>{
          const sku=b.dataset.editn;
          const row=qs("adminStocksTable").querySelector(`[data-rowi="${sku}"]`);
          row.querySelectorAll(`input[data-sku="${sku}"]`).forEach(inp=>inp.disabled=false);
          row.querySelector(`[data-editn="${sku}"]`).classList.add("hidden");
          row.querySelector(`[data-saven="${sku}"]`).classList.remove("hidden");
        };
      });
      qs("adminStocksTable").querySelectorAll("[data-saven]").forEach(b=>{
        b.onclick=async ()=>{
          const sku=b.dataset.saven;
          const row=qs("adminStocksTable").querySelector(`[data-rowi="${sku}"]`);
          const name=row.querySelector(`input[data-sku="${sku}"][data-k="name"]`).value.trim();
          await updateDoc(doc(db,"inventory",sku),{ name });
          row.querySelectorAll(`input[data-sku="${sku}"]`).forEach(inp=>inp.disabled=true);
          row.querySelector(`[data-saven="${sku}"]`).classList.add("hidden");
          row.querySelector(`[data-editn="${sku}"]`).classList.remove("hidden");
        };
      });
      qs("adminStocksTable").querySelectorAll("[data-inc]").forEach(b=>{
        b.onclick=async ()=>{
          const sku=b.dataset.inc;
          const inp=qs("adminStocksTable").querySelector(`[data-add="${sku}"]`);
          const add=Math.max(0, Math.floor(Number(inp.value||0)));
          if(add<=0) return alert("Укажите количество > 0");
          const ref=doc(db,"inventory",sku);
          const snap=await getDoc(ref); if(!snap.exists()) return;
          const qty=Number(snap.data().qty||0)+add;
          await updateDoc(ref,{qty});
          inp.value="";
        };
      });
      qs("adminStocksTable").querySelectorAll("[data-dec]").forEach(b=>{
        b.onclick=async ()=>{
          const sku=b.dataset.dec;
          const inp=qs("adminStocksTable").querySelector(`[data-sub="${sku}"]`);
          const sub=Math.max(0, Math.floor(Number(inp.value||0)));
          if(sub<=0) return alert("Укажите количество > 0");
          const ref=doc(db,"inventory",sku);
          const snap=await getDoc(ref); if(!snap.exists()) return;
          const cur=Number(snap.data().qty||0);
          await updateDoc(ref,{qty:Math.max(0, cur - sub)});
          inp.value="";
        };
      });
      qs("adminStocksTable").querySelectorAll("[data-del]").forEach(b=>{
        b.onclick=async ()=>{
          const sku=b.dataset.del;
          if(!confirm(`Удалить товар ${sku}?`)) return;
          await deleteDoc(doc(db,"inventory",sku));
        };
      });
    }));
  }

  // Админ: заявки (удаление, сорт SKU натур., без ID)
  function fillPointFilter(selId){
    const sel=qs(selId); if(!sel) return;
    const keep = sel.value;
    sel.innerHTML = `<option value="">Все</option>` + state.points.map(p=>`<option value="${p.id}">${p.name||p.email||p.id}</option>`).join("");
    if (keep) sel.value = keep;
  }
  function renderAdminRequests(){
    fillPointFilter("reqPointFilter");
    const sel = qs("reqPointFilter");
    let current = [];
    const invMap = {};
    const unsubInv = onSnapshot(collection(db,"inventory"), s=>{ s.docs.forEach(d=>invMap[d.id]=d.data().name); render(); });
    const unsub = onSnapshot(query(collection(db,"transfers"), orderBy("date","desc")), snap=>{ current = snap.docs.map(d=>({ id:d.id, ...d.data() })); render(); });
    state.unsub.push(unsub, unsubInv);
    sel.onchange = render;

    function render(){
      fillPointFilter("reqPointFilter");
      const pid = sel.value;
      const list = current.filter(t=>!pid || t.pointId===pid);
      const body = list.map(t=>{
        const lines=(t.items||[]).slice().sort((a,b)=>natCmp(a.sku,b.sku)).map(i=>`${i.name || invMap[i.sku] || i.sku} × ${i.qty}`).join(", ");
        const cls=t.status==="Принято"?"ok":"warn";
        const canDel = t.status!=="Принято";
        return `<tr>
          <td class="muted">${t.date}</td>
          <td>${t.pointName||t.pointEmail||""}</td>
          <td>${(t.items||[]).length}</td>
          <td class="muted">${lines}</td>
          <td class="status ${cls}">${t.status||"Новая"}</td>
          <td style="text-align:right;">
            <button class="btn ok" data-acc="${t.id}" ${t.status==="Принято"?"disabled":""}>Принять</button>
            <button class="btn bad" data-delreq="${t.id}" ${canDel?"":"disabled"}>Удалить</button>
          </td>
        </tr>`;
      }).join("");
      qs("adminRequestsTable").innerHTML=`<div class="table-scroll"><table><thead><tr><th>Дата</th><th>Точка</th><th>Строк</th><th>Состав</th><th>Статус</th><th></th></tr></thead><tbody>${body||`<tr><td colspan="6" class="muted">Заявок нет</td></tr>`}</tbody></table></div>`;
      qs("adminRequestsTable").querySelectorAll("[data-acc]").forEach(b=>{ b.onclick=()=>acceptTransfer(b.dataset.acc); });
      qs("adminRequestsTable").querySelectorAll("[data-delreq]").forEach(b=>{
        b.onclick=async ()=>{
          if(!confirm("Удалить заявку?")) return;
          try { await deleteDoc(doc(db,"transfers",b.dataset.delreq)); }
          catch(e){ alert("Не удалось удалить заявку. Проверьте правила Firestore."); }
        };
      });
    }
  }
  async function acceptTransfer(id){
    const tRef=doc(db,"transfers",id);
    const tSnap=await getDoc(tRef);
    if(!tSnap.exists()) return;
    const t=tSnap.data();
    if(t.status==="Принято") return;
    await runTransaction(db, async (trx)=>{
      const items=(t.items||[]);
      for(const it of items){
        const iRef=doc(db,"inventory",it.sku);
        const iSnap=await trx.get(iRef);
        if(!iSnap.exists()) throw new Error(`Товар ${it.sku} не найден`);
        const cur=Number(iSnap.data().qty||0);
        trx.update(iRef,{ qty: Math.max(0, cur - Math.max(0, Math.floor(Number(it.qty||0)))) });
      }
      trx.update(tRef,{ status:"Принято", acceptedAt: Date.now() });
    }).catch(e=>alert("Ошибка при принятии: "+e.message));
  }

  // Админ: вода (удаление + месяц/итого)
  function inRange(dateStr, from, to){
    const a = from || "0000-01-01", b = to || "9999-12-31";
    return (!!dateStr && dateStr>=a && dateStr<=b);
  }
  function renderAdminWater(){
    fillPointFilter("waterPointFilter");
    const sel = qs("waterPointFilter");
    const dFrom = qs("waterFrom"), dTo = qs("waterTo");
    let current = [];
    const unsub = onSnapshot(collection(db,"waters"), snap=>{ current = snap.docs.map(d=>({ id:d.id, ...d.data() })); render(); });
    state.unsub.push(unsub);
    sel.onchange = render; dFrom.onchange=render; dTo.onchange=render;

    function render(){
      fillPointFilter("waterPointFilter");
      const pid = sel.value;
      const list = current.filter(w=>(!pid || w.pointId===pid) && inRange(w.date, dFrom.value, dTo.value)).sort((a,b)=> (b.date||"").localeCompare(a.date||""));
      const body = list.map(w=>{
        const cls=w.status==="Завершен"?"ok":"warn";
        return `<tr>
          <td class="muted">${w.date}</td><td>${w.pointName||w.pointEmail||""}</td><td>${w.qty}</td>
          <td class="status ${cls}">${w.status||"Новый"}</td>
          <td style="text-align:right;">
            <button class="btn ok" data-done="${w.id}" ${w.status==="Завершен"?"disabled":""}>Выполнен</button>
            <button class="btn bad" data-delw="${w.id}">Удалить</button>
          </td>
        </tr>`;
      }).join("");
      qs("adminWaterTable").innerHTML=`<div class="table-scroll"><table><thead><tr><th>Дата</th><th>Точка</th><th>Бутыли</th><th>Статус</th><th></th></tr></thead><tbody>${body||`<tr><td colspan="5" class="muted">Нет заказов</td></tr>`}</tbody></table></div>`;
      qs("adminWaterTable").querySelectorAll("[data-done]").forEach(b=>{
        b.onclick=async ()=>{ await updateDoc(doc(db,"waters",b.dataset.done),{ status:"Завершен" }); };
      });
      qs("adminWaterTable").querySelectorAll("[data-delw]").forEach(b=>{
        b.onclick=async ()=>{ if(confirm("Удалить запись воды?")) await deleteDoc(doc(db,"waters",b.dataset.delw)); };
      });

      const byMonth={}; list.forEach(w=>{ const m=(w.date||"").slice(0,7); if(m) byMonth[m]=(byMonth[m]||0)+Number(w.qty||0); });
      const months = Object.keys(byMonth).sort(); const total = months.reduce((s,m)=>s+byMonth[m],0);
      const mbody = months.map(m=>`<tr><td>${m}</td><td>${byMonth[m]}</td></tr>`).join("");
      qs("adminWaterMonth").innerHTML = `<div class="muted">Итого по месяцам</div><div class="table-scroll"><table><thead><tr><th>Месяц</th><th>Бутыли</th></tr></thead><tbody>${mbody||`<tr><td colspan="2" class="muted">Нет данных</td></tr>`}</tbody><tfoot><tr><td><b>Итого</b></td><td><b>${total}</b></td></tr></tfoot></table></div>`;
    }
  }

  // Админ: инкассации (удаление + итоги)
  function renderAdminCash(){
    fillPointFilter("cashPointFilter");
    const sel = qs("cashPointFilter");
    const dFrom = qs("cashFrom"), dTo = qs("cashTo");
    let current = [];
    const unsub = onSnapshot(collection(db,"cashes"), snap=>{ current = snap.docs.map(d=>({ id:d.id, ...d.data() })); render(); });
    state.unsub.push(unsub);
    sel.onchange = render; dFrom.onchange=render; dTo.onchange=render;

    function render(){
      fillPointFilter("cashPointFilter");
      const pid = sel.value;
      const list = current.filter(c=>(!pid || c.pointId===pid) && inRange(c.date, dFrom.value, dTo.value)).sort((a,b)=> (b.date||"").localeCompare(a.date||""));
      const body = list.map(c=>{
        const diff=((Number(c.meter||0)-Number(c.reported||0))||0).toFixed(2);
        const cls=Math.abs(diff)<0.01?"ok":(diff>0?"warn":"bad");
        return `<tr>
          <td class="muted">${c.date}</td><td>${c.pointName||c.pointEmail||""}</td>
          <td>${Number(c.reported||0).toFixed(2)}</td>
          <td><input type="number" step="0.01" style="width:120px" data-mid="${c.id}" value="${c.meter??''}" placeholder="По метрешке"/></td>
          <td class="status ${cls}">${diff}</td>
          <td style="text-align:right;"><button class="btn bad" data-delc="${c.id}">Удалить</button></td>
        </tr>`;
      }).join("");
      qs("adminCashTable").innerHTML=`<div class="table-scroll"><table><thead><tr><th>Дата</th><th>Точка</th><th>Отчет точки ₽</th><th>По метрешке ₽</th><th>Разница</th><th></th></tr></thead><tbody>${body||`<tr><td colspan="6" class="muted">Нет данных</td></tr>`}</tbody></table></div>`;
      qs("adminCashTable").querySelectorAll("[data-mid]").forEach(inp=>{
        inp.oninput=async ()=>{ await updateDoc(doc(db,"cashes",inp.dataset.mid),{ meter:Number(inp.value||0) }); };
      });
      qs("adminCashTable").querySelectorAll("[data-delc]").forEach(b=>{
        b.onclick=async ()=>{ if(confirm("Удалить инкассацию?")) await deleteDoc(doc(db,"cashes",b.dataset.delc)); };
      });

      const sumReported = list.reduce((s,x)=>s+Number(x.reported||0),0);
      const sumMeter = list.reduce((s,x)=>s+Number(x.meter||0),0);
      const sumDiff = sumMeter - sumReported;
      qs("adminCashTotals").innerHTML = `<div class="muted">Итоги периода</div>
        <div class="table-scroll"><table><thead><tr><th>Отчет ₽</th><th>По метрешке ₽</th><th>Разница ₽</th></tr></thead>
        <tbody><tr><td>${sumReported.toFixed(2)}</td><td>${sumMeter.toFixed(2)}</td><td class="status ${Math.abs(sumDiff)<0.01?'ok':(sumDiff>0?'warn':'bad')}">${sumDiff.toFixed(2)}</td></tr></tbody></table></div>`;
    }
  }

  // Админ: статистика (таблицы + две диаграммы: перемещения и вода)
  function periodToRange(kind){
    const d = new Date(); const to = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    let from = new Date(to);
    if(kind==="yesterday"){ from.setDate(from.getDate()-1); to.setDate(to.getDate()-1); }
    if(kind==="week"){ from.setDate(from.getDate()-6); }
    if(kind==="month"){ from.setDate(1); }
    return { from: from.toISOString().slice(0,10), to: to.toISOString().slice(0,10) };
  }
  function renderAdminStats(){
    const sel = qs("statsPointFilter");
    const per = qs("statsPeriod"), dFrom=qs("statsFrom"), dTo=qs("statsTo");
    fillPointFilter("statsPointFilter");

    let transfers=[], waters=[], invNames={};
    const unsubT = onSnapshot(collection(db,"transfers"), s=>{ transfers=s.docs.map(d=>({id:d.id,...d.data()})); render(); });
    const unsubW = onSnapshot(collection(db,"waters"), s=>{ waters=s.docs.map(d=>({id:d.id,...d.data()})); render(); });
    const unsubI = onSnapshot(collection(db,"inventory"), s=>{ invNames={}; s.docs.forEach(d=>invNames[d.id]=d.data().name); render(); });
    state.unsub.push(unsubT,unsubW,unsubI);

    function updatePeriod(){
      const k = per.value;
      if(k==="custom"){ dFrom.disabled=false; dTo.disabled=false; }
      else { const r=periodToRange(k); dFrom.value=r.from; dTo.value=r.to; dFrom.disabled=true; dTo.disabled=true; }
      render();
    }
    per.onchange=updatePeriod; dFrom.onchange=render; dTo.onchange=render; sel.onchange=render; updatePeriod();

    function inRangeS(d){ const a=dFrom.value||"0000-01-01", b=dTo.value||"9999-12-31"; return d>=a && d<=b; }

    function render(){
      fillPointFilter("statsPointFilter");
      const pid = sel.value||"";

      const map={}; const skus=new Set();
      transfers.filter(t=>inRangeS(t.date||"") && (!pid || t.pointId===pid)).forEach(t=>{
        if(!map[t.date]) map[t.date]={};
        (t.items||[]).forEach(i=>{ map[t.date][i.sku]=(map[t.date][i.sku]||0)+Number(i.qty||0); skus.add(i.sku); });
      });
      const skuList=[...skus].sort(natCmp);
      const head = skuList.map(s=>`<th>${invNames[s]||s}</th>`).join("");
      const body = Object.keys(map).sort().map(d=>{
        const cells = skuList.map(s=>`<td>${map[d][s]||""}</td>`).join("");
        return `<tr><td>${d}</td>${cells}</tr>`;
      }).join("");
      qs("statsTransfers").innerHTML = `<div class="muted">Перемещения по датам</div><div class="table-scroll"><table><thead><tr><th>Дата</th>${head}</tr></thead><tbody>${body || `<tr><td colspan="${1+skuList.length}" class="muted">Нет данных</td></tr>`}</tbody></table></div>`;

      const byDateW={};
      waters.filter(w=>inRangeS(w.date||"") && (!pid || w.pointId===pid)).forEach(w=>{
        byDateW[w.date]=(byDateW[w.date]||0)+Number(w.qty||0);
      });
      const wBody = Object.keys(byDateW).sort().map(d=>`<tr><td>${d}</td><td>${byDateW[d]}</td></tr>`).join("");
      qs("statsWater").innerHTML=`<div class="muted">Заказы воды (19л)</div><div class="table-scroll"><table><thead><tr><th>Дата</th><th>Кол-во</th></tr></thead><tbody>${wBody||`<tr><td colspan="2" class="muted">Нет данных</td></tr>`}</tbody></table></div>`;

      // Диаграммы
      drawBarChart("statsTransfersChart", "Диаграмма перемещений (итого за день)", sumByDate(map));
      drawBarChart("statsWaterChart", "Диаграмма воды", byDateW);
    }
  }
  function sumByDate(map){ const out={}; Object.keys(map).forEach(d=>{ out[d]=Object.values(map[d]).reduce((s,v)=>s+Number(v||0),0); }); return out; }
  function drawBarChart(containerId, title, byDate){
    const cont = qs(containerId);
    const dates = Object.keys(byDate).sort();
    if(!dates.length){ cont.innerHTML=""; return; }
    const values = dates.map(d=>byDate[d]);
    const max = Math.max(...values, 1);
    const w = Math.max(300, dates.length*30), h = 160, pad = 24, barW = Math.max(10, (w - pad*2)/dates.length - 6);
    let bars = "";
    dates.forEach((d,idx)=>{
      const v = byDate[d];
      const bh = Math.round((v/max)*(h-pad*2));
      const x = pad + idx*(barW+6);
      const y = h - pad - bh;
      bars += `<rect x="${x}" y="${y}" width="${barW}" height="${bh}" fill="#6ea8fe"/><text x="${x+barW/2}" y="${h-6}" fill="#8f9bb3" font-size="10" text-anchor="middle">${d.slice(5)}</text>`;
    });
    cont.innerHTML = `<div class="muted">${title}</div><svg width="${w}" height="${h}" style="background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:8px;"><g>${bars}</g></svg>`;
  }

  // Точка: остатки (натурал. сортировка SKU) + заявка
  function renderPointStocks(){
    if(!qs("reqDate").value) qs("reqDate").value=today();
    state.unsub.push(onSnapshot(collection(db,"inventory"), snap=>{
      const rows = snap.docs.map(d=>({ sku:d.id, ...d.data() })).sort((a,b)=>natCmp(a.sku,b.sku));
      const body = rows.map(p=>`
        <tr>
          <td>${p.sku}</td><td>${p.name}</td><td>${fmt(p.qty)}</td>
          <td><input type="number" min="0" max="${p.qty}" value="0" data-req="${p.sku}" data-name="${p.name}" style="width:90px"/></td>
        </tr>`).join("");
      qs("pointStocksTable").innerHTML=`<div class="table-scroll"><table>
        <thead><tr><th>SKU</th><th>Наименование</th><th>Доступно</th><th>К заявке</th></tr></thead>
        <tbody>${body||`<tr><td colspan="4" class="muted">Нет товаров</td></tr>`}</tbody>
      </table></div>`;
    }));
    qs("sendReqBtn").onclick = async ()=>{
      const point = await ensureMyPoint(auth.currentUser);
      const date = qs("reqDate").value || today();
      const inputs = [...document.querySelectorAll('[data-req]')];
      const items = inputs.map(inp=>({ sku:inp.dataset.req, name: inp.dataset.name||inp.dataset.req, qty:Math.max(0, Math.floor(Number(inp.value||0))) })).filter(x=>x.qty>0);
      if(!items.length) return alert("Укажите количества хотя бы по одному товару");
      await addDoc(collection(db,"transfers"), {
        date, items, status:"Новая",
        pointId: point.id, pointName: point.name || "", pointEmail: point.email || "", pointUid: auth.currentUser.uid,
        createdAt: Date.now()
      });
      alert("Заявка отправлена");
      renderPointStocks();
    };
  }
  function renderPointMyReq(){
    const unsub = onSnapshot(query(collection(db,"transfers"), where("pointUid","==",auth.currentUser.uid)), snap=>{
      const list = snap.docs.map(d=>({ id:d.id, ...d.data() })).sort((a,b)=> (b.date||"").localeCompare(a.date||""));
      const body = list.map(t=>{
        const lines=(t.items||[]).slice().sort((a,b)=>natCmp(a.sku,b.sku)).map(i=>`${i.name||i.sku} × ${i.qty}`).join(", ");
        return `<tr>
          <td class="muted">${t.date}</td>
          <td>${lines}</td>
          <td class="status ${t.status==="Принято"?"ok":"warn"}">${t.status||"Новая"}</td>
        </tr>`;
      }).join("");
      qs("pointMyReqTable").innerHTML = `<div class="table-scroll"><table><thead><tr><th>Дата</th><th>Состав</th><th>Статус</th></tr></thead><tbody>${body||`<tr><td colspan="3" class="muted">Заявок нет</td></tr>`}</tbody></table></div>`;
    });
    state.unsub.push(unsub);
  }
  function renderPointWater(){
    if(!qs("waterDate").value) qs("waterDate").value=today();
    const unsub = onSnapshot(query(collection(db,"waters"), where("pointUid","==",auth.currentUser.uid)), snap=>{
      const list = snap.docs.map(d=>({ id:d.id, ...d.data() })).sort((a,b)=> (b.date||"").localeCompare(a.date||""));
      const rows = list.map(w=>`<tr><td>${w.date}</td><td>${w.qty}</td><td class="status ${w.status==="Завершен"?"ok":"warn"}">${w.status||"Новый"}</td></tr>`).join("");
      qs("pointWaterList").innerHTML=`<div class="table-scroll"><table><thead><tr><th>Дата</th><th>Бутыли</th><th>Статус</th></tr></thead><tbody>${rows||`<tr><td colspan="3" class="muted">Пока нет</td></tr>`}</tbody></table></div>`;
    });
    state.unsub.push(unsub);
    qs("sendWaterBtn").onclick=async ()=>{
      const point = await ensureMyPoint(auth.currentUser);
      const date=qs("waterDate").value||today();
      const qty=Math.max(1, Number(qs("waterQty").value||1));
      await addDoc(collection(db,"waters"), {
        date, qty, status:"Новый",
        pointId: point.id, pointName: point.name || "", pointEmail: point.email || "", pointUid: auth.currentUser.uid,
        createdAt: Date.now()
      });
      alert("Заказ воды отправлен");
    };
  }
  function renderPointCash(){
    if(!qs("cashDate").value) qs("cashDate").value=today();
    const unsub = onSnapshot(query(collection(db,"cashes"), where("pointUid","==",auth.currentUser.uid)), snap=>{
      const list = snap.docs.map(d=>({ id:d.id, ...d.data() })).sort((a,b)=> (b.date||"").localeCompare(a.date||""));
      const rows=list.map(c=>{
        const diff=((Number(c.meter||0)-Number(c.reported||0))||0).toFixed(2);
        const cls=Math.abs(diff)<0.01?"ok":(diff>0?"warn":"bad");
        return `<tr><td>${c.date}</td><td>${Number(c.reported||0).toFixed(2)}</td><td class="muted">${c.meter??""}</td><td class="status ${cls}">${diff}</td></tr>`;
      }).join("");
      qs("pointCashList").innerHTML=`<div class="table-scroll"><table><thead><tr><th>Дата</th><th>Отчет ₽</th><th>По метрешке ₽</th><th>Разница</th></tr></thead><tbody>${rows||`<tr><td colspan="4" class="muted">Пока нет</td></tr>`}</tbody></table></div>`;
    });
    state.unsub.push(unsub);
    qs("sendCashBtn").onclick=async ()=>{
      const point = await ensureMyPoint(auth.currentUser);
      const date=qs("cashDate").value||today();
      const reported=Math.max(0, Number(qs("cashAmt").value||0));
      if(reported<=0) return alert("Введите сумму > 0");
      await addDoc(collection(db,"cashes"), { date, reported, pointId: point.id, pointName: point.name || "", pointEmail: point.email || "", pointUid: auth.currentUser.uid, createdAt: Date.now() });
      alert("Инкассация записана");
      qs("cashAmt").value="";
    };
  }
</script>
</body>
</html>
